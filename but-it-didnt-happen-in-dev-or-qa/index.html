<!DOCTYPE html>
<html lang="en" data-theme="dark"><head>
    <title>But it Didn&#39;t Happen in DEV or QA! | David Haney</title>	
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-PR2HVYP6QG"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'G-PR2HVYP6QG');
	</script>
    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.78.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Programmer / Engineering Manager">
    
    <link rel="stylesheet"
          href="https://www.davidhaney.io/css/style.min.2b188541d728e8afd69a6f1b8b83f89f2b138d671fb728eff20ff3f3dcf5b55e.css"
          integrity="sha256-KxiFQdco6K/Wmm8bi4P4nysTjWcftyjv8g/z89z1tV4="
          crossorigin="anonymous"
          type="text/css">
    <link rel="stylesheet"
          href="https://www.davidhaney.io/css/syntax.21cc1ccec065ce1e0f94f7a6a5a26cb58c9044e659b5010305c81fe0a1d47029.css"
          integrity="sha256-IcwczsBlzh4PlPempaJstYyQROZZtQEDBcgf4KHUcCk="
          crossorigin="anonymous"
          type="text/css">
    <link rel="stylesheet"
          href="https://www.davidhaney.io/css/custom.75ff12cf57a7d0b97e613904a37c6a42ada450dc1204d089fea2bf639b95bd11.css"
          integrity="sha256-df8Sz1en0Ll&#43;YTkEo3xqQq2kUNwSBNCJ/qK/Y5uVvRE="
          crossorigin="anonymous"
          type="text/css"><link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://www.davidhaney.io/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://www.davidhaney.io/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.davidhaney.io/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.davidhaney.io/favicons/favicon-16x16.png">

    <link rel="canonical" href="https://www.davidhaney.io/but-it-didnt-happen-in-dev-or-qa/">

    
    
    
    
    <script type="text/javascript"
            src="https://www.davidhaney.io/js/anatole-header.min.e782db136ec18d105a4552702eac49f4620d6867da3fbf808bd53e806c96be6e.js"
            integrity="sha256-54LbE27BjRBaRVJwLqxJ9GINaGfaP7&#43;Ai9U&#43;gGyWvm4="
            crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.davidhaney.io/img/opengraph.png"/>

<meta name="twitter:title" content="But it Didn&#39;t Happen in DEV or QA!"/>
<meta name="twitter:description" content="Most of us have been there: you’ve written a fantastic application that performs perfectly in your Development and/or QA environments, but in Production something goes wrong. Your application spins out of control, utilizing 100% of your CPU."/>

</head>
<body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
        <div class="title">
            <img src="https://www.davidhaney.io/img/me.jpg" alt="profile picture">
            <h3 title=""><a href="/">David Haney</a></h3>
            <div class="description">
                <p>Programmer / Engineering Manager</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://www.github.com/haneytron" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.twitter.com/haneytron" rel="me" aria-label="Twitter">
                    <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.linkedin.com/in/davidahaney" rel="me" aria-label="Linkedin">
                    <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; David Haney 2020 </div>
    </div>
</div>
<div class="main">
    <div class="page-top animated fadeInDown">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/tags/"
                        
                   title="">Tags</a></li>
        
        
        <li class="theme-switch-item">
            <a class="theme-switch" title="Switch Theme">
                <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post animated fadeInDown">
        <div class="post-content">

            <div class="post-title">
                <h3>But it Didn&#39;t Happen in DEV or QA!</h3>
                
                    <div class="info">
                        <em class="fa fa-sun-o"></em>
                        <span class="date">Sun, Dec 2, 2012</span>
                        <em class="fa fa-clock-o"></em>
                        <span class="reading-time">7-minute read</span>
                    </div>
                
            </div>

            <p>Most of us have been there: you’ve written a fantastic application that performs perfectly in your Development and/or QA environments, but in Production something goes wrong. Your application spins out of control, utilizing 100% of your CPU. Maybe it simply stops responding as if it were deadlocked. Or maybe it simply crashes randomly. What now?</p>
<p>Logic tells you that you have a problem in the code somewhere that is only encountered in a Production-like environment… and if you could JUST get into the Production box, install Visual Studio (or at least the Remote Debugger), and debug the application, you’d be able to solve the problem. However, you can’t (because it’s Production!), and you can’t replicate the problem in any other environment. Maybe it’s because of stale Development or QA environment data compared to live Production data. Maybe it’s something else. You have no idea where to look to find and fix the problem in your application. For lack of eloquence: you’re screwed.</p>
<p>Fortunately, there are both tools designed for this very scenario and ways to “reproduce” the problem to determine the cause. I’m going to show you how to debug Production problems in applications where you cannot attach to the process for live debugging, and there are either no logs or the logs tell you nothing useful.</p>
<p>Let’s create a simple application that is designed to take up 100% of our CPU:</p>
<pre><code>class Program
{
    static void Main(string[] args)
    {
        // Parallel to really max out the CPU
        Parallel.For(0, 100, (i) =&gt;
        {
            while (true)
            {
                // Loop forever and ever
            }
        });
    }
}
</code></pre>
<p>This code basically spawns 100 concurrent threads that loop for all of eternity. The reason that we do this using the TPL / Parallel library is that a single threaded application would only max out 1/N of our CPU, where N is the number of cores in the processor. Verifying our simple application, we can see that it does its job and maxes out our CPU:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-1.png"/> <figcaption>
            <h4>100% CPU Used</h4>
        </figcaption>
</figure>

<p>Now, imagine that this application is a lot more complex and that this simple method is just one part of the entire solution. Perhaps you’ve built a really huge website or service and this method exists in just one little part of it. Pretend also that this method is not hit in your Development or QA environments during testing, and so your application appears to operate normally to you.</p>
<p>In fact, pretend that you’ve never seen this source code at all. All that you know is that you have an application in Production that spins out of control, and you don’t know where the problem is – or even where to begin looking.</p>
<p><strong>So, what do you do?</strong></p>
<p>The first thing we need to do is ensure that we have the tools we’ll need to debug and fix the issue. Things you’re going to need:</p>
<ul>
<li>A tool that can create Mini-Dumps. I highly recommend <!-- raw HTML omitted -->Process Explorer<!-- raw HTML omitted --> which is available via TechNet.</li>
<li><!-- raw HTML omitted -->WinDBG, via Debugging Tools for Windows<!-- raw HTML omitted -->, an unintuitive yet key tool from Microsoft for debugging Mini-Dump files. When you install this, you’ll have to do it through the Windows Software Development Kit installer. You can unselect everything except Debugging Tools for Windows, since you’ll need nothing else for our purposes. <!-- raw HTML omitted --></li>
</ul>
<p>Install WinDBG on the PC which you’ll use to analyze the Mini-Dump (typically your Development machine). Install Process Explorer on the Production box that hosts the application which is misbehaving.</p>
<p><strong>Now that you’ve got those installed, we’ll proceed and figure out the problem.</strong></p>
<p>So our scenario is this: we have an application running in Production which is spinning out of control, we have the source code on a different PC, and we can’t attach a debugger to the Production environment. We can’t reproduce this behaviour in Development or QA environments at all. So, time to get down to the details of the problem.</p>
<p>Step 1 is easy. You need to take a Mini-Dump of the misbehaving application on the Production machine. There’s a bit of a catch 22 here in that the rogue application is using 100% of your CPU, so this Mini-Dump could take forever. To solve that problem on a multi-core machine, simply use Task Manager to set the affinity of the misbehaving application to 1 or 2 cores to lower the total CPU used by the application, thus freeing up CPU for our Mini-Dump:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-2.png"/> <figcaption>
            <h4>Set the Affinity to 1 or 2 CPUs</h4>
        </figcaption>
</figure>

<p>Unselect “All Processors” and pick 1 or 2:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-3.png"/> <figcaption>
            <h4>Pick 1 or 2 CPUs</h4>
        </figcaption>
</figure>

<p>There, now it’s a lot easier to do things on the affected PC since it isn’t spending 100% of its CPU spinning on your application:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-4.png"/> <figcaption>
            <h4>Processor Now Freed Up</h4>
        </figcaption>
</figure>

<p>Note that the affinity setting does not persist, meaning the next time you launch the application, it will go back to using all CPUs per usual.</p>
<p>So, now we’re on to Step 2. Take a Mini-Dump (haha). To do this, launch Process Explorer, find your rogue application, right click, Create Dump –&gt; Minidump:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-5.png"/> <figcaption>
            <h4>Create a Minidump</h4>
        </figcaption>
</figure>

<p>Now save the .dmp file somewhere that your Development PC can get to it in order to debug the issue.</p>
<p>Step 3. Great, so now we have our .dmp Mini-Dump file… so let’s get cracking on debugging it. Get the .dmp file to your Development PC and fire up WinDBG. <strong>NOTE: run the 64 bit version for 64 bit applications and the 32 bit version for 32 bit applications. If you experience weird behaviour, try switching the WinDBG version that you launch.</strong> You’ll be greeted with a pretty bland grey window. Go to File –&gt; Open Crash Dump (or CTRL + D for the shortcut fans out there). Select your .dmp file and you’ll end up with a screen similar to this:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-6.png"/> <figcaption>
            <h4>Minidump File Loaded</h4>
        </figcaption>
</figure>

<p>So now the “hard” part begins. We need to manually diagnose the issue. The first step in WinDBG is usually to load up the CLR runtime so that we can examine our stack. To do this, run either:</p>
<pre><code>.loadby SOS clr            // for .NET 4+
</code></pre>
<p><strong>OR</strong></p>
<pre><code>.loadby SOS mscorwks       // for .NET 3.5 or lower
</code></pre>
<p>My app is .NET 4, so I ran .loadby sos clr to load the CLR. This is what it should look like if it succeeds:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-10.png"/> <figcaption>
            <h4>Load the CLR</h4>
        </figcaption>
</figure>

<p>Next we need to load the symbols for the application that we’re debugging. To do this, run the following commands:</p>
<pre><code>.symfix
.sympath+ **&lt;absolute path to your application's compiled code and symbols&gt;**
</code></pre>
<p>Here’s what I did for my Symbol Path for reference:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-7.png"/> <figcaption>
            <h4>Run .symfix and .sympath</h4>
        </figcaption>
</figure>

<p>Next, run .symopt+0x40 to enable symbols to be used which are not perfectly matched. This setting is extremely useful in cases where the code is compiled locally and doesn’t perfectly match the production code that the Mini-Dump was taken from. If this setting is omitted, you will have a very bad time determining the issue, so make sure that you run it. This is what it looks like:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-8.png"/> <figcaption>
            <h4>Run symopt&#43;0x40</h4>
        </figcaption>
</figure>

<p>Now that you’ve specified the path at which to look for symbols for your application, run the reload command to reload your symbols:</p>
<pre><code>.reload /v /f
</code></pre>
<p>You might get some warnings and errors here but that’s usually fine as long as they don’t relate to your application’s DLLs. Verify that it found your application’s symbols by reading the output of the .reload command:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-9.png"/> <figcaption>
            <h4>Ensure your symbols loaded</h4>
        </figcaption>
</figure>

<p>Alright, almost there! Now we have our symbols and CLR loaded, so let’s find out what our application is spending all of its time doing. Run the command:</p>
<pre><code>!runaway
</code></pre>
<p>And you’ll find out which threads have been using the most CPU time. Mine looks like this:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-11.png"/> <figcaption>
            <h4>Many Threads are Long Running</h4>
        </figcaption>
</figure>

<p>So here we can see that we have 6 threads which are taking up more time than all of the others… We need to print their stack traces and see just what is going on. Execute this (super intuitive) command to see the stack trace of the first thread:</p>
<pre><code>~~[9:18a8]e!clrstack
</code></pre>
<p>Super intuitive right? Basically it says “gimme the CLR stack trace for the thread whose ID is in the square brackets”. Here’s what mine spits out:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-12.png"/> <figcaption>
            <h4>AHA! The culprit!</h4>
        </figcaption>
</figure>

<p>And now we know the culprit! So, we proceed to our source code and sure enough, line 16 is our problem:</p>
<figure>
    <img src="/img/but-it-didnt-happen-in-dev-or-qa-13.png"/> <figcaption>
            <h4>The Problem Line</h4>
        </figcaption>
</figure>

<p>And there you have it. How to debug production issues from your development environment.</p>
<p>Note that you can also determine what caused a crash using WinDBG… Have your system administrator enable Mini-Dumps for crashes, and then perform the same commands as we did in this post EXCEPT that at the part where we ran !runaway, instead run !analyze -v and !clrstack – these will get you on your way!</p>

        </div>
        <div class="post-footer">
            <div class="info">
                <span class="separator"><a class="category" href="/categories/blog/">blog</a></span>

                <span class="separator"><a class="tag" href="/tags/dotnet/">dotnet</a><a class="tag" href="/tags/debugging/">debugging</a><a class="tag" href="/tags/performance/">performance</a><a class="tag" href="/tags/profiling/">profiling</a><a class="tag" href="/tags/programming/">programming</a><a class="tag" href="/tags/windbg/">windbg</a></span>

            </div>
        </div>

        
            <div id="fb_comments_container">
                    <h2>comments</h2>
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "haney" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://www.davidhaney.io/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js"
        integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw="
        crossorigin="anonymous"></script>




<script type="text/javascript"
        src="https://www.davidhaney.io/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js"
        integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4="
        crossorigin="anonymous"></script>

<script type="text/javascript"
        src="https://www.davidhaney.io/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script>
</body>

</html>
