<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Custom ASP.NET MVC Action Result Cache Attribute - Haney Codes .NET - Sharing my experiences as a developer and engineering manager.</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="David Haney" />
  <meta name="description" content="If you&amp;#8217;re working on an application built using ASP.NET MVC, you&amp;#8217;re hopefully aware of the OutputCacheAttribute attribute which can be used to statically cache your dynamic web pages. By adding this attribute to a controller or action method, the output of the method(s) will be stored in memory. For example, if your action method renders a view, then the view page will be cached in memory. This cached view page is then available to the application for all subsequent requests (or until the item expires out of the cache), which can retrieve it from the memory rather than redoing the work to re-create the result again." />

  <meta name="keywords" content="blog, .net, c#, developer, manager, david, haney, code, stack, overflow, github, twitter, linkedin" />






<meta name="generator" content="Hugo 0.41" />


<link rel="canonical" href="http://www.haneycodes.net/custom-asp-net-mvc-action-result-cache-attribute/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.1.1" rel="preload" as="style">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="preload" as="style">



<link href="/css/custom.css" rel="preload" as="style">


<meta property="og:title" content="Custom ASP.NET MVC Action Result Cache Attribute" />
<meta property="og:description" content="If you&#8217;re working on an application built using ASP.NET MVC, you&#8217;re hopefully aware of the OutputCacheAttribute attribute which can be used to statically cache your dynamic web pages. By adding this attribute to a controller or action method, the output of the method(s) will be stored in memory. For example, if your action method renders a view, then the view page will be cached in memory. This cached view page is then available to the application for all subsequent requests (or until the item expires out of the cache), which can retrieve it from the memory rather than redoing the work to re-create the result again." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.haneycodes.net/custom-asp-net-mvc-action-result-cache-attribute/" />



<meta property="article:published_time" content="2017-01-10T09:07:15&#43;00:00"/>

<meta property="article:modified_time" content="2017-01-10T09:07:15&#43;00:00"/>











<meta itemprop="name" content="Custom ASP.NET MVC Action Result Cache Attribute">
<meta itemprop="description" content="If you&#8217;re working on an application built using ASP.NET MVC, you&#8217;re hopefully aware of the OutputCacheAttribute attribute which can be used to statically cache your dynamic web pages. By adding this attribute to a controller or action method, the output of the method(s) will be stored in memory. For example, if your action method renders a view, then the view page will be cached in memory. This cached view page is then available to the application for all subsequent requests (or until the item expires out of the cache), which can retrieve it from the memory rather than redoing the work to re-create the result again.">


<meta itemprop="datePublished" content="2017-01-10T09:07:15&#43;00:00" />
<meta itemprop="dateModified" content="2017-01-10T09:07:15&#43;00:00" />
<meta itemprop="wordCount" content="1041">



<meta itemprop="keywords" content="dotnet,caching,mvc,performance,programming," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Custom ASP.NET MVC Action Result Cache Attribute"/>
<meta name="twitter:description" content="If you&#8217;re working on an application built using ASP.NET MVC, you&#8217;re hopefully aware of the OutputCacheAttribute attribute which can be used to statically cache your dynamic web pages. By adding this attribute to a controller or action method, the output of the method(s) will be stored in memory. For example, if your action method renders a view, then the view page will be cached in memory. This cached view page is then available to the application for all subsequent requests (or until the item expires out of the cache), which can retrieve it from the memory rather than redoing the work to re-create the result again."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Haney Codes .NET</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Haney Codes .NET</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Custom ASP.NET MVC Action Result Cache Attribute</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-01-10 </span>
        <div class="post-category">
            
              <a href="/categories/blog/"> blog </a>
            
          </div>
        <span class="more-meta"> 1041 words </span>
        <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    
  </div>
</div>

    
    

    
    <div class="post-content">
      <p>If you&#8217;re working on an application built using ASP.NET MVC, you&#8217;re hopefully aware of the <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.outputcacheattribute(v=vs.118).aspx">OutputCacheAttribute</a> attribute which can be used to statically cache your dynamic web pages. By adding this attribute to a controller or action method, the output of the method(s) will be stored in memory. For example, if your action method renders a view, then the view page will be cached in memory. This cached view page is then available to the application for all subsequent requests (or until the item expires out of the cache), which can retrieve it from the memory rather than redoing the work to re-create the result again. This is the essence of caching: trading memory for performance.</p>

<p>The OutputCacheAttribute is a really powerful way to improve performance in your MVC application, but isn&#8217;t always the most practical. Because it caches the entire page as raw HTML, it circumvents a large part of the MVC pipeline and thus also skips the code that runs to generate the page. This means that if your view has dynamic content that comes from session or ViewData, such as displaying the currently logged in user&#8217;s name in the top bar, or the current time of day, or the resulting view of an invalid form post which tells your user to correct their input errors, you&#8217;ll quickly discover the error of your ways when you try to cache that page. When David accesses the logged in page for the first time and caches it, everybody else who logs in will be called David on the page. And if David fills out your empty form and presses submit, only to cache the resulting input validation error page, then everybody will see David&#8217;s completed form when they have errors too &#8211; maybe even including sensitive data like his username, password, or even his credit card information. I think that most of us have seen this kind of (often humorous) caching error before. It&#8217;s scary stuff, nonetheless.</p>

<p>A great way to balance the benefits of output caching with the dynamic content and features that the modern ASP.NET MVC web application offers is to create a custom caching attribute. This attribute can cache the <strong>ActionResult</strong> instead of the raw HTML of the page, and in doing so will allow you to cache all of the work that is done to generate the ActionResult (be it ViewResult or otherwise). By executing <em>within</em> the MVC pipeline, this custom caching attribute will not interrupt or short-circuit the MVC pipeline. This allows for things like SessionState or ViewData to vary per cached request! It&#8217;s not quite as efficient as the true OutputCacheAttribute, but my custom ActionResultCacheAttribute is an excellent tradeoff between performance and dynamic data:</p>

<pre><code>/// &lt;summary&gt;
/// Caches the result of an action method.
/// NOTE: you'll need refs to System.Web.Mvc and System.Runtime.Caching
/// &lt;/summary&gt;
[AttributeUsage(AttributeTargets.Method | AttributeTargets.Class, AllowMultiple = false, Inherited = false)]
public class ActionResultCacheAttribute : ActionFilterAttribute
{
    private static readonly Dictionary&lt;string, string[]&gt; _varyByParamsSplitCache = new Dictionary&lt;string, string[]&gt;();
    private static readonly ReaderWriterLockSlim _lock = new ReaderWriterLockSlim();
    private static readonly MemoryCache _cache = new MemoryCache(&quot;ActionResultCacheAttribute&quot;);

    /// &lt;summary&gt;
    /// The comma separated parameters to vary the caching by.
    /// &lt;/summary&gt;
    public string VaryByParam { get; set; }

    /// &lt;summary&gt;
    /// The sliding expiration, in seconds.
    /// &lt;/summary&gt;
    public int SlidingExpiration { get; set; }

    /// &lt;summary&gt;
    /// The duration to cache before expiration, in seconds.
    /// &lt;/summary&gt;
    public int Duration { get; set; }

    /// &lt;summary&gt;
    /// Occurs when an action is executing.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;filterContext&quot;&gt;The filter context.&lt;/param&gt;
    public override void OnActionExecuting(ActionExecutingContext filterContext)
    {
        // Create the cache key
        var cacheKey = CreateCacheKey(filterContext.RouteData.Values, filterContext.ActionParameters);

        // Try and get the action method result from cache
        var result = _cache.Get(cacheKey) as ActionResult;
        if (result != null)
        {
            // Set the result
            filterContext.Result = result;
            return;
        }

        // Store to HttpContext Items
        filterContext.HttpContext.Items[&quot;__actionresultcacheattribute_cachekey&quot;] = cacheKey;
    }

    /// &lt;summary&gt;
    /// Occurs when an action has executed.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;filterContext&quot;&gt;The filter context.&lt;/param&gt;
    public override void OnActionExecuted(ActionExecutedContext filterContext)
    {
        // Don't cache errors
        if (filterContext.Exception != null)
        {
            return;
        }

        // Get the cache key from HttpContext Items
        var cacheKey = filterContext.HttpContext.Items[&quot;__actionresultcacheattribute_cachekey&quot;] as string;
        if (string.IsNullOrWhiteSpace(cacheKey))
        {
            return;
        }

        // Cache the result of the action method
        if (SlidingExpiration != 0)
        {
            _cache.Add(cacheKey, filterContext.Result, TimeSpan.FromSeconds(SlidingExpiration));
            return;
        }

        if (Duration != 0)
        {
            _cache.Add(cacheKey, filterContext.Result, DateTime.UtcNow.AddSeconds(Duration));
            return;
        }

        // Default to 1 hour
        _cache.Add(cacheKey, filterContext.Result, DateTime.UtcNow.AddSeconds(60 * 60));
    }

    /// &lt;summary&gt;
    /// Creates the cache key.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;routeValues&quot;&gt;The route values.&lt;/param&gt;
    /// &lt;returns&gt;The cache key.&lt;/returns&gt;
    private string CreateCacheKey(RouteValueDictionary routeValues, IDictionary&lt;string, object&gt; actionParameters)
    {
        // Create the cache key prefix as the controller and action method
        var sb = new StringBuilder(routeValues[&quot;controller&quot;].ToString());
        sb.Append(&quot;_&quot;).Append(routeValues[&quot;action&quot;].ToString());

        if (string.IsNullOrWhiteSpace(VaryByParam))
        {
            return sb.ToString();
        }

        // Append the cache key from the vary by parameters
        object varyByParamObject = null;
        string[] varyByParamsSplit = null;
        bool gotValue = false;

        _lock.EnterReadLock();
        try
        {
            gotValue = _varyByParamsSplitCache.TryGetValue(VaryByParam, out varyByParamsSplit);
        }
        finally
        {
            _lock.ExitReadLock();
        }

        if (!gotValue)
        {
            _lock.EnterWriteLock();
            try
            {
                varyByParamsSplit = VaryByParam.Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries);
                _varyByParamsSplitCache[VaryByParam] = varyByParamsSplit;
            }
            finally
            {
                _lock.ExitWriteLock();
            }
        }

        foreach (var varyByParam in varyByParamsSplit)
        {
            // Skip invalid parameters
            if (!actionParameters.TryGetValue(varyByParam, out varyByParamObject))
            {
                continue;
            }

            // Sometimes a parameter will be null
            if (varyByParamObject == null)
            {
                continue;
            }

            sb.Append(&quot;_&quot;).Append(varyByParamObject.ToString());
        }

        return sb.ToString();
    }
}
</code></pre>

<p>You can use this method on a controller to affect all action methods:</p>

<pre><code>[ActionResultCache(Duration = 60 * 60 * 24)]
public class HomeController : Controller
{
    public async Task&lt;ActionResult&gt; TermsOfService()
    {
        return View();
    }
}
</code></pre>

<p>Or just apply it to individual action methods:</p>

<pre><code>[ActionResultCache(Duration = 60 * 60 * 24)]
public async Task&lt;ActionResult&gt; TermsOfService()
{
    return View();
}
</code></pre>

<p>You can also use it with the <code>VaryByParam</code> property to vary the cached result by the parameter(s) of the action method:</p>

<pre><code>[ActionResultCache(Duration = 60 * 60 * 24, VaryByParam = &quot;username&quot;)]
public async Task&lt;ActionResult&gt; ViewUser(string username)
{
    var model = new UserModel
    {
        Username = username,
        ...
    };

    return View(model);
}
</code></pre>

<p>The main benefit of this custom caching attribute is that your session state and all global action filter attributes, etc. still run in the MVC pipeline as they would normally. The only code cached and skipped over is the method body of the action method.</p>

<p>Please use and enjoy! Feedback welcomed in the comments.</p>

    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/dotnet/">dotnet</a>
          
          <a href="/tags/caching/">caching</a>
          
          <a href="/tags/mvc/">mvc</a>
          
          <a href="/tags/performance/">performance</a>
          
          <a href="/tags/programming/">programming</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/dev-team-interactions-accountability-blame/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Dev Team Interactions: Accountability &amp; Blame</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/our-industry-needs-compassion/">
            <span class="next-text nav-default">Our Industry Needs Compassion</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'haney';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://stackoverflow.com/users/2420979/haney" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://www.twitter.com/haneycodes" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.linkedin.com/in/davidahaney" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://www.github.com/haneytron" class="iconfont icon-github" title="github"></a>
  <a href="http://www.haneycodes.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2012 - 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">David Haney</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001" defer></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js" defer></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js" defer></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js" defer></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.1.1" defer></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-50502107-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>






<script src="/js/custom.js" defer></script>



<link href="/dist/even.min.css?v=3.1.1" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">



<link href="/css/custom.css" rel="stylesheet">

</body>
</html>
