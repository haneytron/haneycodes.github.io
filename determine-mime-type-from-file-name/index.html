<!DOCTYPE html>
<html lang="en" data-theme="dark"><head>
    <title>Determine MIME Type from File Name | David Haney</title>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-2YNL1EJF5C"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-PR2HVYP6QG');
	</script>
    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.78.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Programmer / Engineering Manager">
    
    <link rel="stylesheet"
          href="https://www.davidhaney.io/css/style.min.2b188541d728e8afd69a6f1b8b83f89f2b138d671fb728eff20ff3f3dcf5b55e.css"
          integrity="sha256-KxiFQdco6K/Wmm8bi4P4nysTjWcftyjv8g/z89z1tV4="
          crossorigin="anonymous"
          type="text/css">
    <link rel="stylesheet"
          href="https://www.davidhaney.io/css/syntax.21cc1ccec065ce1e0f94f7a6a5a26cb58c9044e659b5010305c81fe0a1d47029.css"
          integrity="sha256-IcwczsBlzh4PlPempaJstYyQROZZtQEDBcgf4KHUcCk="
          crossorigin="anonymous"
          type="text/css"><link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" 
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" 
    crossorigin="anonymous" />

    
    <link rel="shortcut icon" href="https://www.davidhaney.io/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://www.davidhaney.io/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.davidhaney.io/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.davidhaney.io/favicons/favicon-16x16.png">

    <link rel="canonical" href="https://www.davidhaney.io/determine-mime-type-from-file-name/">

    
    
    
    
    <script type="text/javascript"
            src="https://www.davidhaney.io/js/anatole-header.min.e782db136ec18d105a4552702eac49f4620d6867da3fbf808bd53e806c96be6e.js"
            integrity="sha256-54LbE27BjRBaRVJwLqxJ9GINaGfaP7&#43;Ai9U&#43;gGyWvm4="
            crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.davidhaney.io/img/opengraph.png"/>

<meta name="twitter:title" content="Determine MIME Type from File Name"/>
<meta name="twitter:description" content="I recently had a need, in an ASP.NET MVC3 application, to read raw HTML, CSS, JS, and image files from disk and return them to the user… A sort of “pass-through” if you will."/>

</head>
<body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
        <div class="title">
            <img src="https://www.davidhaney.io/img/me.jpg" alt="profile picture">
            <h3 title=""><a href="/">David Haney</a></h3>
            <div class="description">
                <p>Programmer / Engineering Manager</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://www.github.com/haneytron" rel="me" aria-label="GitHub">
                    <i class="fab fa-github fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.twitter.com/haneytron" rel="me" aria-label="Twitter">
                    <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.linkedin.com/in/davidahaney" rel="me" aria-label="Linkedin">
                    <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; David Haney 2020 </div>
    </div>
</div>
<div class="main">
    <div class="page-top animated fadeInDown">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/post/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/tags/"
                        
                   title="">Tags</a></li>
        
        
        <li class="theme-switch-item">
            <a class="theme-switch" title="Switch Theme">
                <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post animated fadeInDown">
        <div class="post-content">

            <div class="post-title">
                <h3>Determine MIME Type from File Name</h3>
                
                    <div class="info">
                        <em class="fa fa-sun-o"></em>
                        <span class="date">Mon, Feb 11, 2013</span>
                        <em class="fa fa-clock-o"></em>
                        <span class="reading-time">4-minute read</span>
                    </div>
                
            </div>

            <p>I recently had a need, in an ASP.NET MVC3 application, to read raw HTML, CSS, JS, and image files from disk and return them to the user… A sort of “pass-through” if you will. Normally I’d have simply routed to a custom HTTP handler per file type or just allowed MVC3 to map existing files to supply its own .NET HTTP handlers and do all of this work for me, but in this case I needed the mapped “directory” to switch behind the scenes based on Session settings… So I ultimately had to feed these files through a Controller and Action Method to gain access to the Session.</p>
<p>One problem that came up was being able to determine the MIME type of the content that I’m reading from disk. This is done for you by the HTTP handlers provided in the .NET framework, but when you’re serving files through MVC Controllers, the default HTTP handlers are not used and thus you’re left to figure out the MIME types for yourself.</p>
<p>So, I began to investigate, using <!-- raw HTML omitted -->ILSpy<!-- raw HTML omitted -->, how the native/default ASP.NET HTTP handlers determine the MIME types. I came upon a class in the <!-- raw HTML omitted -->System.Web<!-- raw HTML omitted --> namespace called <!-- raw HTML omitted -->System.Web.MimeMapping<!-- raw HTML omitted --> – this class keeps a private, sealed dictionary of type MimeMappingDictionaryClassic (which extends a private abstract class called MimeMappingDictionaryBase) which holds all knows extensions and their associated MIME types… A sample of the decompiled code which populates it is below:</p>
<pre><code>protected override void PopulateMappings()
{
    base.AddMapping(&quot;.323&quot;, &quot;text/h323&quot;);
    base.AddMapping(&quot;.aaf&quot;, &quot;application/octet-stream&quot;);
    base.AddMapping(&quot;.aca&quot;, &quot;application/octet-stream&quot;);
    base.AddMapping(&quot;.accdb&quot;, &quot;application/msaccess&quot;);
    base.AddMapping(&quot;.accde&quot;, &quot;application/msaccess&quot;);
    base.AddMapping(&quot;.accdt&quot;, &quot;application/msaccess&quot;);
    base.AddMapping(&quot;.acx&quot;, &quot;application/internet-property-stream&quot;);
    base.AddMapping(&quot;.afm&quot;, &quot;application/octet-stream&quot;);
    base.AddMapping(&quot;.ai&quot;, &quot;application/postscript&quot;);
    base.AddMapping(&quot;.aif&quot;, &quot;audio/x-aiff&quot;);
    base.AddMapping(&quot;.aifc&quot;, &quot;audio/aiff&quot;);
    base.AddMapping(&quot;.aiff&quot;, &quot;audio/aiff&quot;);
    ... // It goes on for a long time
</code></pre>
<p>And so on… In total, there are 342 lines of known mappings!</p>
<p>Ultimately, my goal was to get a hold of this functionality in the easiest, most flexible way possible.</p>
<p>In .NET 4.5, MimeMapping exposes a public static method called <!-- raw HTML omitted -->GetMimeMapping<!-- raw HTML omitted --> which takes in a file name (or extension) and returns the appropriate MIME type from the aforementioned dictionary. Unfortunately my project is on .NET 4.0 and in that version of the framework this method is internal, not public (why, Microsoft, why?!) and thus was not available to me. So, I felt that I was left with 3 options:</p>
<ol>
<li>
<p>Upgrade to .NET 4.5 (not possible at this time due to corporate politics and so on)</p>
</li>
<li>
<p>Copy and paste the entire list of mappings into a dictionary of my own and reference it (yuck!)</p>
</li>
<li>
<p>REFLECTION TO THE RESCUE!</p>
</li>
</ol>
<p>So, with a short bit of code, you too can steal the functionality of the GetMimeMapping method, even if it isn’t public!</p>
<p>First, set up the reflection and cache the MethodInfo in an assembly that references the <!-- raw HTML omitted -->System.Web<!-- raw HTML omitted --> namespace. Below is a custom static class I built which wraps the reflective method:</p>
<pre><code>/// &lt;summary&gt;
/// Exposes the Mime Mapping method that Microsoft hid from us.
/// &lt;/summary&gt;
public static class MimeMappingStealer
{
    // The get mime mapping method info
    private static readonly MethodInfo _getMimeMappingMethod = null;

    /// &lt;summary&gt;
    /// Static constructor sets up reflection.
    /// &lt;/summary&gt;
    static MimeMappingStealer()
    {
        // Load hidden mime mapping class and method from System.Web
        var assembly = Assembly.GetAssembly(typeof(HttpApplication));
        Type mimeMappingType = assembly.GetType(&quot;System.Web.MimeMapping&quot;);
        _getMimeMappingMethod = mimeMappingType.GetMethod(&quot;GetMimeMapping&quot;, 
            BindingFlags.Instance | BindingFlags.Static | BindingFlags.Public |
            BindingFlags.NonPublic | BindingFlags.FlattenHierarchy);
    }

    /// &lt;summary&gt;
    /// Exposes the hidden Mime mapping method.
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;fileName&quot;&gt;The file name.&lt;/param&gt;
    /// &lt;returns&gt;The mime mapping.&lt;/returns&gt;
    public static string GetMimeMapping(string fileName)
    {
        return (string)_getMimeMappingMethod.Invoke(null /*static method*/, new[] { fileName });
    }
}
</code></pre>
<p>Now, a quick test via a console application to ensure that it works:</p>
<pre><code>static void Main(string[] args)
{
    var fileName1 = &quot;whatever.js&quot;;
    var fileName2 = &quot;somefile.css&quot;;
    var fileName3 = &quot;myfile.html&quot;;

    Console.WriteLine(&quot;Output for &quot; + fileName1 + &quot; = &quot; 
        + MimeMappingStealer.GetMimeMapping(fileName1));
    Console.WriteLine(&quot;Output for &quot; + fileName2 + &quot; = &quot; 
        + MimeMappingStealer.GetMimeMapping(fileName2));
    Console.WriteLine(&quot;Output for &quot; + fileName3 + &quot; = &quot; 
        + MimeMappingStealer.GetMimeMapping(fileName3));

    Console.ReadKey();
}
</code></pre>
<p>And running the console application results in success!</p>
<figure>
    <img src="/img/get-mime-mapping.png"/> <figcaption>
            <h4>GetMimeMapping Works!</h4>
        </figcaption>
</figure>


        </div>
        <div class="post-footer">
            <div class="info">
                <span class="separator"><a class="category" href="/categories/blog/">blog</a></span>

                <span class="separator"><a class="tag" href="/tags/dotnet/">dotnet</a><a class="tag" href="/tags/csharp/">csharp</a><a class="tag" href="/tags/performance/">performance</a><a class="tag" href="/tags/programming/">programming</a><a class="tag" href="/tags/reflection/">reflection</a></span>

            </div>
        </div>

        
            <div id="fb_comments_container">
                    <h2>comments</h2>
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "haney" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://www.davidhaney.io/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js"
        integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw="
        crossorigin="anonymous"></script>




<script type="text/javascript"
        src="https://www.davidhaney.io/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js"
        integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4="
        crossorigin="anonymous"></script>

<script type="text/javascript"
        src="https://www.davidhaney.io/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script>
</body>

</html>
